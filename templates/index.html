<!DOCTYPE html>
<html lang="es" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Plan Manager</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wood: { light: '#d4a574', DEFAULT: '#8b5a2b', dark: '#5c3d2e' }
                    }
                }
            }
        }
    </script>
    <style>
        .grid-pattern {
            background-image:
                linear-gradient(rgba(100, 116, 139, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 116, 139, 0.05) 1px, transparent 1px);
            background-size: 25px 25px;
        }

        .dark .grid-pattern {
            background-image:
                linear-gradient(rgba(148, 163, 184, 0.06) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.06) 1px, transparent 1px);
        }

        .wood-texture {
            background: linear-gradient(135deg, #d4a574 0%, #c49a6c 25%, #b8956a 50%, #c9a070 75%, #d4a574 100%);
        }

        .dark .wood-texture {
            background: linear-gradient(135deg, #8b6914 0%, #7a5c12 25%, #6d5210 50%, #7a5c12 75%, #8b6914 100%);
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.9);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out;
        }

        .animate-slideUp {
            animation: slideUp 0.2s ease-out;
        }

        .table-item {
            touch-action: none;
            user-select: none;
            -webkit-touch-callout: none;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.25));
        }

        .table-item.dragging {
            opacity: 0.85;
            z-index: 1000;
            cursor: grabbing;
            transform: scale(1.08);
            filter: drop-shadow(0 12px 24px rgba(0, 0, 0, 0.4));
        }

        /* Realistic Wood Table Surface */
        .table-surface {
            background: linear-gradient(135deg, #8B5A2B 0%, #A0522D 25%, #8B4513 50%, #A0522D 75%, #8B5A2B 100%);
            background-size: 100% 100%;
            border-radius: 10px;
            position: relative;
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                0 4px 0 #5D3A1A,
                0 6px 0 #4A2E14,
                0 8px 15px rgba(0, 0, 0, 0.3);
        }

        .table-surface::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(90deg,
                    transparent,
                    transparent 8px,
                    rgba(139, 69, 19, 0.15) 8px,
                    rgba(139, 69, 19, 0.15) 10px);
            border-radius: 10px;
            pointer-events: none;
        }

        .table-surface::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg,
                    rgba(255, 255, 255, 0.15) 0%,
                    transparent 40%,
                    transparent 60%,
                    rgba(0, 0, 0, 0.1) 100%);
            border-radius: 10px;
            pointer-events: none;
        }

        .dark .table-surface {
            background: linear-gradient(135deg, #6B4423 0%, #7B4E2A 25%, #5D3A1A 50%, #7B4E2A 75%, #6B4423 100%);
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.1),
                inset 0 -2px 4px rgba(0, 0, 0, 0.3),
                0 4px 0 #3D2A12,
                0 6px 0 #2D1E0C,
                0 8px 15px rgba(0, 0, 0, 0.5);
        }

        /* Status Glow Rings - FORCING to override table-surface */
        .status-free {
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                0 4px 0 #5D3A1A,
                0 6px 0 #4A2E14,
                0 8px 15px rgba(0, 0, 0, 0.3),
                0 0 0 5px rgba(16, 185, 129, 1),
                0 0 35px rgba(16, 185, 129, 0.7) !important;
        }

        .status-reserved {
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                0 4px 0 #5D3A1A,
                0 6px 0 #4A2E14,
                0 8px 15px rgba(0, 0, 0, 0.3),
                0 0 0 5px rgba(244, 63, 94, 1),
                0 0 35px rgba(244, 63, 94, 0.7) !important;
            animation: pulse-reserved 2s ease-in-out infinite;
        }

        .status-occupied {
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                0 4px 0 #5D3A1A,
                0 6px 0 #4A2E14,
                0 8px 15px rgba(0, 0, 0, 0.3),
                0 0 0 5px rgba(245, 158, 11, 1),
                0 0 35px rgba(245, 158, 11, 0.7) !important;
        }

        /* Alignment Guide Lines */
        .align-guide {
            position: absolute;
            background: rgba(99, 102, 241, 0.8);
            z-index: 999;
            pointer-events: none;
        }

        .align-guide.horizontal {
            height: 2px;
            left: 0;
            right: 0;
        }

        .align-guide.vertical {
            width: 2px;
            top: 0;
            bottom: 0;
        }

        .align-guide::before {
            content: '';
            position: absolute;
            background: inherit;
        }

        @keyframes pulse-reserved {

            0%,
            100% {
                box-shadow:
                    inset 0 2px 4px rgba(255, 255, 255, 0.2),
                    inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                    0 4px 0 #5D3A1A,
                    0 6px 0 #4A2E14,
                    0 8px 15px rgba(0, 0, 0, 0.3),
                    0 0 0 4px rgba(244, 63, 94, 0.6),
                    0 0 25px rgba(244, 63, 94, 0.4);
            }

            50% {
                box-shadow:
                    inset 0 2px 4px rgba(255, 255, 255, 0.2),
                    inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                    0 4px 0 #5D3A1A,
                    0 6px 0 #4A2E14,
                    0 8px 15px rgba(0, 0, 0, 0.3),
                    0 0 0 5px rgba(244, 63, 94, 0.8),
                    0 0 35px rgba(244, 63, 94, 0.6);
            }
        }

        /* Realistic 3D Chairs - LARGER */
        .chair-3d {
            width: 32px;
            height: 22px;
            position: relative;
        }

        .chair-3d .seat {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 14px;
            background: linear-gradient(180deg, #8B5A2B 0%, #6B4423 100%);
            border-radius: 5px 5px 3px 3px;
            box-shadow:
                inset 0 2px 3px rgba(255, 255, 255, 0.25),
                0 3px 0 #4A2E14,
                0 4px 6px rgba(0, 0, 0, 0.35);
        }

        .chair-3d .back {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 26px;
            height: 10px;
            background: linear-gradient(180deg, #A0522D 0%, #8B4513 100%);
            border-radius: 5px 5px 2px 2px;
            box-shadow:
                inset 0 1px 3px rgba(255, 255, 255, 0.2),
                0 2px 3px rgba(0, 0, 0, 0.25);
        }

        .dark .chair-3d .seat {
            background: linear-gradient(180deg, #7B4E2A 0%, #5D3A1A 100%);
            box-shadow:
                inset 0 2px 3px rgba(255, 255, 255, 0.1),
                0 3px 0 #3D2A12,
                0 4px 6px rgba(0, 0, 0, 0.5);
        }

        .dark .chair-3d .back {
            background: linear-gradient(180deg, #8B5A2B 0%, #6B4423 100%);
        }

        /* Bottom chairs (rotated 180deg) */
        .chair-3d.bottom {
            transform: rotate(180deg);
        }

        /* Status Badge */
        .status-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .status-badge.free {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .status-badge.reserved {
            background: linear-gradient(135deg, #F43F5E, #E11D48);
        }

        .status-badge.occupied {
            background: linear-gradient(135deg, #F59E0B, #D97706);
        }

        /* Mobile Responsive Improvements */
        @media (max-width: 640px) {
            .table-item {
                transform: scale(0.85);
            }

            #floor-plan {
                min-width: 100% !important;
            }

            .zone-btn,
            .shift-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
        }

        /* Touch-friendly buttons */
        button,
        input,
        select,
        textarea {
            min-height: 44px;
        }

        /* Smooth scrolling */
        #map-container {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 min-h-screen transition-colors duration-300">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100 dark:bg-slate-900">
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4">
            </div>
            <p class="text-slate-500 dark:text-slate-400">Cargando...</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">

        <!-- Header -->
        <header
            class="bg-white dark:bg-slate-800 shadow-sm border-b border-slate-200 dark:border-slate-700 sticky top-0 z-40">
            <div class="max-w-full mx-auto px-4 py-3">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">

                    <!-- Logo -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                            <i class="fa-solid fa-utensils text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-slate-800 dark:text-white">Floor Plan Manager</h1>
                            <p class="text-xs text-slate-500 dark:text-slate-400 hidden sm:block">Sistema de Gesti√≥n de
                                Mesas</p>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex flex-wrap items-center gap-2 lg:gap-3">
                        <!-- Date Picker (Improved) -->
                        <div
                            class="flex items-center rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden">
                            <button id="date-prev"
                                class="px-2.5 py-2 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-500 dark:text-slate-400 transition-colors">
                                <i class="fa-solid fa-chevron-left text-xs"></i>
                            </button>
                            <div class="flex items-center gap-2 px-3 py-2 bg-white dark:bg-slate-800 cursor-pointer"
                                onclick="document.getElementById('date-picker').showPicker()">
                                <i class="fa-regular fa-calendar text-indigo-500"></i>
                                <span id="date-display"
                                    class="text-sm font-medium text-slate-700 dark:text-slate-200 min-w-[100px] text-center"></span>
                                <input type="date" id="date-picker" class="sr-only">
                            </div>
                            <button id="date-next"
                                class="px-2.5 py-2 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-500 dark:text-slate-400 transition-colors">
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </button>
                            <button id="date-today"
                                class="px-2.5 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-medium transition-colors"
                                title="Ir a hoy">
                                Hoy
                            </button>
                        </div>

                        <!-- Zone Buttons -->
                        <div class="flex rounded-lg overflow-hidden border border-slate-200 dark:border-slate-600">
                            <button data-zone="interior"
                                class="zone-btn px-3 py-2 text-sm font-medium bg-indigo-600 text-white">
                                <i class="fa-solid fa-house mr-1 hidden sm:inline"></i>Interior
                            </button>
                            <button data-zone="terraza"
                                class="zone-btn px-3 py-2 text-sm font-medium bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600">
                                <i class="fa-solid fa-tree mr-1 hidden sm:inline"></i>Terraza
                            </button>
                        </div>

                        <!-- Shift Selector -->
                        <div class="flex rounded-lg overflow-hidden border border-slate-200 dark:border-slate-600">
                            <button data-shift="mediodia"
                                class="shift-btn px-3 py-2 text-sm font-medium bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600">
                                <i class="fa-solid fa-sun mr-1 hidden sm:inline"></i>Mediod√≠a
                            </button>
                            <button data-shift="noche"
                                class="shift-btn px-3 py-2 text-sm font-medium bg-amber-500 text-white">
                                <i class="fa-solid fa-moon mr-1 hidden sm:inline"></i>Noche
                            </button>
                        </div>

                        <!-- Admin Controls (hidden for viewers) -->
                        <div id="admin-controls" class="hidden flex items-center gap-2">
                            <button id="btn-add-table"
                                class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg flex items-center gap-1 transition-colors">
                                <i class="fa-solid fa-plus"></i>
                                <span class="hidden sm:inline">Nueva Mesa</span>
                            </button>
                        </div>
                    </div>

                    <!-- User Controls -->
                    <div class="flex items-center gap-2 lg:gap-3">
                        <!-- Legend -->
                        <div
                            class="hidden xl:flex items-center gap-3 text-xs border-r border-slate-200 dark:border-slate-600 pr-3">
                            <div class="flex items-center gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
                                <span class="text-slate-500 dark:text-slate-400">Libre</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-rose-500"></div>
                                <span class="text-slate-500 dark:text-slate-400">Reservada</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-amber-500"></div>
                                <span class="text-slate-500 dark:text-slate-400">Ocupada</span>
                            </div>
                        </div>

                        <!-- Sync Status -->
                        <div id="sync-indicator"
                            class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-xs"
                            title="Sincronizaci√≥n autom√°tica activa">
                            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                            <span class="hidden sm:inline text-emerald-700 dark:text-emerald-300">Live</span>
                        </div>

                        <!-- Role Badge -->
                        <div id="role-badge"
                            class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300">
                            <i id="role-icon" class="fa-solid fa-user"></i>
                            <span id="role-text">Usuario</span>
                        </div>

                        <!-- Dark Mode -->
                        <button id="dark-toggle"
                            class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                            <i class="fa-solid fa-moon dark:hidden"></i>
                            <i class="fa-solid fa-sun hidden dark:block"></i>
                        </button>

                        <!-- Logout -->
                        <button id="logout-btn"
                            class="p-2 rounded-lg bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 hover:bg-rose-200 dark:hover:bg-rose-900/50 transition-colors">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Canvas -->
        <main id="map-container" class="relative overflow-auto" style="height: calc(100vh - 72px);">
            <div class="absolute inset-0 grid-pattern bg-slate-50 dark:bg-slate-900"></div>
            <div id="floor-plan" class="relative w-full h-full min-w-[800px] min-h-[600px] p-6"></div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-overlay"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div id="modal-box"
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md animate-slideUp max-h-[90vh] overflow-y-auto">
            <div id="modal-header"
                class="p-5 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-800 z-10">
                <h2 id="modal-title" class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                </h2>
                <button id="modal-close"
                    class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div id="modal-content" class="p-5"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

    <script>
        // =============================================
        // API MODULE
        // =============================================
        const API = {
            async request(method, url, data = null) {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (data) options.body = JSON.stringify(data);

                const response = await fetch(url, options);
                return response.json();
            },

            // Auth
            login: (username, password) => API.request('POST', '/api/login', { username, password }),
            logout: () => API.request('POST', '/api/logout'),
            getSession: () => API.request('GET', '/api/session'),

            // Tables
            getTables: (fecha = null, turno = null) => {
                let url = '/api/tables';
                const params = [];
                if (fecha) params.push(`fecha=${fecha}`);
                if (turno) params.push(`turno=${turno}`);
                if (params.length) url += '?' + params.join('&');
                return API.request('GET', url);
            },
            createTable: (data) => API.request('POST', '/api/tables', data),
            updateTable: (id, data) => API.request('PUT', `/api/tables/${id}`, data),
            deleteTable: (id) => API.request('DELETE', `/api/tables/${id}`),
            updatePosition: (id, x, y) => API.request('POST', `/api/tables/${id}/position`, { x, y }),

            // Reservations
            reserveTable: (id, data) => API.request('POST', `/api/tables/${id}/reserve`, data),
            occupyTable: (id) => API.request('POST', `/api/tables/${id}/occupy`, {
                fecha: State.selectedDate,
                turno: State.currentShift
            }),
            freeTable: (id) => API.request('POST', `/api/tables/${id}/free`)
        };

        // =============================================
        // STATE
        // =============================================
        const State = {
            user: null,
            tables: [],
            currentZone: 'interior',
            currentShift: new Date().getHours() < 17 ? 'mediodia' : 'noche',
            selectedDate: new Date().toISOString().split('T')[0]
        };

        // =============================================
        // UTILS
        // =============================================
        const Utils = {
            showToast(message, type = 'info') {
                const colors = {
                    success: 'bg-emerald-600',
                    warning: 'bg-amber-600',
                    error: 'bg-rose-600',
                    info: 'bg-indigo-600'
                };
                const toast = document.createElement('div');
                toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg animate-slideUp text-sm flex items-center gap-2`;
                toast.innerHTML = `<i class="fa-solid fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(10px)';
                    toast.style.transition = 'all 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            canEdit() {
                return State.user && ['admin', 'editor'].includes(State.user.role);
            },

            isAdmin() {
                return State.user && State.user.role === 'admin';
            }
        };

        // =============================================
        // AUTH MODULE
        // =============================================
        const Auth = {
            async init() {
                // Check for stored user
                const storedUser = localStorage.getItem('user');
                if (storedUser) {
                    try {
                        const result = await API.getSession();
                        if (result.success) {
                            State.user = result.user;
                            return true;
                        }
                    } catch (e) { }
                }
                // Redirect to login
                window.location.href = '/login';
                return false;
            },

            updateUI() {
                const badge = document.getElementById('role-badge');
                const icon = document.getElementById('role-icon');
                const text = document.getElementById('role-text');
                const adminControls = document.getElementById('admin-controls');

                const configs = {
                    admin: { bg: 'bg-purple-100 dark:bg-purple-900/30', text: 'text-purple-700 dark:text-purple-300', icon: 'fa-crown', label: 'Admin' },
                    editor: { bg: 'bg-blue-100 dark:bg-blue-900/30', text: 'text-blue-700 dark:text-blue-300', icon: 'fa-pen', label: 'Editor' },
                    viewer: { bg: 'bg-slate-100 dark:bg-slate-700', text: 'text-slate-700 dark:text-slate-300', icon: 'fa-eye', label: 'Viewer' }
                };

                const config = configs[State.user.role] || configs.viewer;
                badge.className = `flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium ${config.bg} ${config.text}`;
                icon.className = `fa-solid ${config.icon}`;
                text.textContent = config.label;

                // Show admin controls
                if (Utils.canEdit()) {
                    adminControls.classList.remove('hidden');
                    adminControls.classList.add('flex');
                }
            },

            async logout() {
                await API.logout();
                localStorage.removeItem('user');
                window.location.href = '/login';
            }
        };

        // =============================================
        // TABLE RENDERER
        // =============================================
        const TableRenderer = {
            container: null,

            init() {
                this.container = document.getElementById('floor-plan');
            },

            async loadAndRender() {
                const tables = await API.getTables(State.selectedDate, State.currentShift);
                State.tables = tables;
                this.render();
            },

            render() {
                this.container.innerHTML = '';
                const filtered = State.tables.filter(t => t.zone === State.currentZone);

                filtered.forEach((table, i) => {
                    const el = this.createTableElement(table);
                    el.style.animationDelay = `${i * 30}ms`;
                    this.container.appendChild(el);
                });
            },

            createTableElement(table) {
                const el = document.createElement('div');
                el.id = `table-${table.id}`;
                el.className = 'table-item absolute cursor-pointer animate-fadeIn';
                el.style.left = `${table.x}px`;
                el.style.top = `${table.y}px`;
                el.dataset.id = table.id;

                const width = table.capacity <= 2 ? 100 : table.capacity <= 4 ? 130 : table.capacity <= 6 ? 160 : 190;
                const height = 75;

                const statusConfig = {
                    free: {
                        class: 'status-free',
                        badge: 'free',
                        icon: 'fa-check',
                        label: 'Libre'
                    },
                    reserved: {
                        class: 'status-reserved',
                        badge: 'reserved',
                        icon: 'fa-calendar-check',
                        label: 'Reservada'
                    },
                    occupied: {
                        class: 'status-occupied',
                        badge: 'occupied',
                        icon: 'fa-utensils',
                        label: 'Ocupada'
                    }
                };
                const config = statusConfig[table.status] || statusConfig.free;
                const canDrag = Utils.canEdit();

                el.innerHTML = `
                <!-- Top chairs -->
                <div class="absolute -top-7 left-1/2 -translate-x-1/2 flex gap-1">
                    ${this.generateChairs(Math.ceil(table.capacity / 2), false)}
                </div>
                
                <!-- Table surface -->
                <div class="table-surface ${config.class} flex items-center justify-center relative transition-all hover:scale-[1.02]"
                     style="width: ${width}px; height: ${height}px;">
                    
                    <!-- Status badge -->
                    <div class="status-badge ${config.badge}">
                        <i class="fa-solid ${config.icon}"></i>
                    </div>
                    
                    <!-- Table content -->
                    <div class="text-center z-10 px-2">
                        <div class="font-bold text-base text-white drop-shadow-md">${table.name}</div>
                        <div class="text-xs text-white/80 font-medium">${table.capacity} pax</div>
                        <div class="text-[10px] text-white/60 mt-0.5 font-medium uppercase tracking-wide">${config.label}</div>
                    </div>
                </div>
                
                <!-- Bottom chairs -->
                <div class="absolute -bottom-7 left-1/2 -translate-x-1/2 flex gap-1">
                    ${this.generateChairs(Math.floor(table.capacity / 2), true)}
                </div>
            `;

                // Tooltip with reservation info
                if (table.status === 'reserved' && table.reservation_info) {
                    el.title = `üóìÔ∏è ${table.reservation_info.customer_name}\n‚è∞ ${table.reservation_info.time}\nüë• ${table.reservation_info.guests || table.capacity} personas`;
                } else if (table.status === 'occupied') {
                    el.title = 'üçΩÔ∏è Mesa actualmente ocupada';
                } else {
                    el.title = `‚úÖ ${table.name} - Disponible (${table.capacity} personas)`;
                }

                // Events
                if (canDrag) {
                    DragHandler.attach(el, table);
                } else {
                    el.addEventListener('click', () => Modal.openTableDetails(table));
                }

                return el;
            },

            generateChairs(count, isBottom) {
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `<div class="chair-3d ${isBottom ? 'bottom' : ''}">
                        <div class="back"></div>
                        <div class="seat"></div>
                    </div>`;
                }
                return html;
            }
        };

        // =============================================
        // IMPROVED DRAG HANDLER
        // =============================================
        const DragHandler = {
            activeElement: null,
            startX: 0,
            startY: 0,
            initialLeft: 0,
            initialTop: 0,
            hasMoved: false,
            moveThreshold: 5,

            attach(element, table) {
                // Mouse Events
                element.addEventListener('mousedown', (e) => this.start(e, element, table));

                // Touch Events
                element.addEventListener('touchstart', (e) => this.startTouch(e, element, table), { passive: false });
            },

            start(e, element, table) {
                if (e.button !== 0) return; // Only left click
                e.preventDefault();
                e.stopPropagation();

                this.activeElement = element;
                this.startX = e.clientX;
                this.startY = e.clientY;
                this.initialLeft = table.x;
                this.initialTop = table.y;
                this.hasMoved = false;
                this.currentTable = table;

                // Pausar sincronizaci√≥n durante el drag
                SyncController.setDragging(table.id, table.x, table.y);

                document.addEventListener('mousemove', this.move);
                document.addEventListener('mouseup', this.end);
                document.addEventListener('mouseleave', this.end); // Handle mouse leaving window
            },

            startTouch(e, element, table) {
                if (e.touches.length !== 1) return;
                e.preventDefault();
                e.stopPropagation();

                const touch = e.touches[0];
                this.activeElement = element;
                this.startX = touch.clientX;
                this.startY = touch.clientY;
                this.initialLeft = table.x;
                this.initialTop = table.y;
                this.hasMoved = false;
                this.currentTable = table;

                // Pausar sincronizaci√≥n durante el drag
                SyncController.setDragging(table.id, table.x, table.y);

                document.addEventListener('touchmove', this.moveTouch, { passive: false });
                document.addEventListener('touchend', this.endTouch);
                document.addEventListener('touchcancel', this.endTouch); // Handle touch interruption
            },

            move: (e) => {
                if (!DragHandler.activeElement) return;
                e.preventDefault();

                const dx = e.clientX - DragHandler.startX;
                const dy = e.clientY - DragHandler.startY;

                // Check if we've moved enough to consider it a drag
                if (!DragHandler.hasMoved && (Math.abs(dx) > DragHandler.moveThreshold || Math.abs(dy) > DragHandler.moveThreshold)) {
                    DragHandler.hasMoved = true;
                    DragHandler.activeElement.classList.add('dragging');
                }

                if (DragHandler.hasMoved) {
                    let newX = Math.max(0, DragHandler.initialLeft + dx);
                    let newY = Math.max(0, DragHandler.initialTop + dy);

                    // Snap alignment
                    const snapResult = DragHandler.checkSnapAlignment(newX, newY);
                    newX = snapResult.x;
                    newY = snapResult.y;
                    DragHandler.showGuides(snapResult.guides);

                    requestAnimationFrame(() => {
                        if (DragHandler.activeElement) {
                            DragHandler.activeElement.style.left = `${newX}px`;
                            DragHandler.activeElement.style.top = `${newY}px`;
                        }
                    });
                }
            },

            SNAP_THRESHOLD: 15,

            checkSnapAlignment(x, y) {
                const currentId = DragHandler.currentTable.id;
                const container = document.getElementById('floor-plan');
                const containerRect = container.getBoundingClientRect();
                const guides = [];
                let snappedX = x;
                let snappedY = y;

                // Get current element dimensions
                const el = DragHandler.activeElement;
                const elWidth = el.offsetWidth || 130;
                const elHeight = el.offsetHeight || 100;

                // Calculate snap points for current table
                const currentPoints = {
                    left: x,
                    centerX: x + elWidth / 2,
                    right: x + elWidth,
                    top: y,
                    centerY: y + elHeight / 2,
                    bottom: y + elHeight
                };

                // Check against all other tables
                State.tables.filter(t => t.id !== currentId && t.zone === State.currentZone).forEach(table => {
                    const otherEl = document.getElementById(`table-${table.id}`);
                    if (!otherEl) return;

                    const otherWidth = otherEl.offsetWidth || 130;
                    const otherHeight = otherEl.offsetHeight || 100;

                    const otherPoints = {
                        left: table.x,
                        centerX: table.x + otherWidth / 2,
                        right: table.x + otherWidth,
                        top: table.y,
                        centerY: table.y + otherHeight / 2,
                        bottom: table.y + otherHeight
                    };

                    // Horizontal alignment (Y axis)
                    if (Math.abs(currentPoints.top - otherPoints.top) < DragHandler.SNAP_THRESHOLD) {
                        snappedY = otherPoints.top;
                        guides.push({ type: 'horizontal', pos: otherPoints.top });
                    } else if (Math.abs(currentPoints.centerY - otherPoints.centerY) < DragHandler.SNAP_THRESHOLD) {
                        snappedY = otherPoints.centerY - elHeight / 2;
                        guides.push({ type: 'horizontal', pos: otherPoints.centerY });
                    } else if (Math.abs(currentPoints.bottom - otherPoints.bottom) < DragHandler.SNAP_THRESHOLD) {
                        snappedY = otherPoints.bottom - elHeight;
                        guides.push({ type: 'horizontal', pos: otherPoints.bottom });
                    }

                    // Vertical alignment (X axis)
                    if (Math.abs(currentPoints.left - otherPoints.left) < DragHandler.SNAP_THRESHOLD) {
                        snappedX = otherPoints.left;
                        guides.push({ type: 'vertical', pos: otherPoints.left });
                    } else if (Math.abs(currentPoints.centerX - otherPoints.centerX) < DragHandler.SNAP_THRESHOLD) {
                        snappedX = otherPoints.centerX - elWidth / 2;
                        guides.push({ type: 'vertical', pos: otherPoints.centerX });
                    } else if (Math.abs(currentPoints.right - otherPoints.right) < DragHandler.SNAP_THRESHOLD) {
                        snappedX = otherPoints.right - elWidth;
                        guides.push({ type: 'vertical', pos: otherPoints.right });
                    }
                });

                return { x: snappedX, y: snappedY, guides };
            },

            showGuides(guides) {
                // Remove existing guides
                document.querySelectorAll('.align-guide').forEach(g => g.remove());

                const container = document.getElementById('floor-plan');

                guides.forEach(guide => {
                    const el = document.createElement('div');
                    el.className = `align-guide ${guide.type}`;

                    if (guide.type === 'horizontal') {
                        el.style.top = `${guide.pos}px`;
                    } else {
                        el.style.left = `${guide.pos}px`;
                    }

                    container.appendChild(el);
                });
            },

            clearGuides() {
                document.querySelectorAll('.align-guide').forEach(g => g.remove());
            },

            moveTouch: (e) => {
                if (!DragHandler.activeElement || e.touches.length !== 1) return;
                e.preventDefault();

                const touch = e.touches[0];
                const dx = touch.clientX - DragHandler.startX;
                const dy = touch.clientY - DragHandler.startY;

                if (!DragHandler.hasMoved && (Math.abs(dx) > DragHandler.moveThreshold || Math.abs(dy) > DragHandler.moveThreshold)) {
                    DragHandler.hasMoved = true;
                    DragHandler.activeElement.classList.add('dragging');
                }

                if (DragHandler.hasMoved) {
                    const newX = Math.max(0, DragHandler.initialLeft + dx);
                    const newY = Math.max(0, DragHandler.initialTop + dy);
                    requestAnimationFrame(() => {
                        if (DragHandler.activeElement) {
                            DragHandler.activeElement.style.left = `${newX}px`;
                            DragHandler.activeElement.style.top = `${newY}px`;
                        }
                    });
                }
            },

            cleanup: () => {
                document.removeEventListener('mousemove', DragHandler.move);
                document.removeEventListener('mouseup', DragHandler.end);
                document.removeEventListener('mouseleave', DragHandler.end);
                document.removeEventListener('touchmove', DragHandler.moveTouch);
                document.removeEventListener('touchend', DragHandler.endTouch);
                document.removeEventListener('touchcancel', DragHandler.endTouch);
                DragHandler.clearGuides();
            },

            end: async () => {
                if (!DragHandler.activeElement) return;

                const element = DragHandler.activeElement;
                const table = DragHandler.currentTable;
                const moved = DragHandler.hasMoved;

                element.classList.remove('dragging');
                DragHandler.cleanup();
                DragHandler.activeElement = null;

                if (moved && table) {
                    const newX = parseInt(element.style.left);
                    const newY = parseInt(element.style.top);
                    table.x = newX;
                    table.y = newY;

                    try {
                        await API.updatePosition(table.id, newX, newY);
                        SyncController.localPositions[table.id] = { x: newX, y: newY };
                    } catch (e) {
                        console.error('Error saving position', e);
                    }
                } else if (table) {
                    Modal.openTableDetails(table);
                }

                // Reanudar sincronizaci√≥n
                if (table) SyncController.clearDragging(table.id);
            },

            endTouch: async () => {
                if (!DragHandler.activeElement) return;

                const element = DragHandler.activeElement;
                const table = DragHandler.currentTable;
                const moved = DragHandler.hasMoved;

                element.classList.remove('dragging');
                DragHandler.cleanup();
                DragHandler.activeElement = null;

                if (moved && table) {
                    const newX = parseInt(element.style.left);
                    const newY = parseInt(element.style.top);
                    table.x = newX;
                    table.y = newY;

                    try {
                        await API.updatePosition(table.id, newX, newY);
                        SyncController.localPositions[table.id] = { x: newX, y: newY };
                    } catch (e) {
                        console.error('Error saving position', e);
                    }
                } else if (table) {
                    Modal.openTableDetails(table);
                }

                // Reanudar sincronizaci√≥n
                if (table) SyncController.clearDragging(table.id);
            }
        };

        // =============================================
        // MODAL
        // =============================================
        const Modal = {
            overlay: null,
            title: null,
            content: null,
            currentTable: null,

            init() {
                this.overlay = document.getElementById('modal-overlay');
                this.title = document.getElementById('modal-title');
                this.content = document.getElementById('modal-content');

                document.getElementById('modal-close').addEventListener('click', () => this.close());
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) this.close();
                });
            },

            open(title, iconClass = 'fa-info-circle') {
                this.title.innerHTML = `<i class="fa-solid ${iconClass} text-indigo-500"></i> ${title}`;
                this.overlay.classList.remove('hidden');
            },

            close() {
                this.overlay.classList.add('hidden');
                this.content.innerHTML = '';
                this.currentTable = null;
            },

            openTableDetails(table) {
                this.currentTable = table;

                if (table.status === 'free') {
                    this.open(table.name, 'fa-chair');
                    this.renderFreeTableOptions(table);
                } else {
                    this.open(table.name, table.status === 'reserved' ? 'fa-calendar-check' : 'fa-utensils');
                    this.renderOccupiedDetails(table);
                }
            },

            renderFreeTableOptions(table) {
                const canEdit = Utils.canEdit();

                this.content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-800 rounded-xl flex items-center justify-center">
                                <i class="fa-solid fa-chair text-emerald-600 dark:text-emerald-300"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-emerald-900 dark:text-emerald-100">${table.name}</div>
                                <div class="text-sm text-emerald-600 dark:text-emerald-300">Capacidad: ${table.capacity} personas - Disponible</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Occupy Without Reservation (only today + current shift) -->
                    ${(() => {
                        const hoy = new Date().toISOString().split('T')[0];
                        const turnoActual = new Date().getHours() < 17 ? 'mediodia' : 'noche';
                        const puedeOcupar = State.selectedDate === hoy && State.currentShift === turnoActual;
                        if (puedeOcupar) {
                            return `<button onclick="Modal.occupyWalkIn('${table.id}')" class="w-full py-4 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2 text-lg">
                                <i class="fa-solid fa-user-plus"></i>
                                Ocupar Mesa (Sin Reserva)
                            </button>`;
                        } else {
                            const turnoNombre = turnoActual === 'mediodia' ? 'Mediod√≠a' : 'Noche';
                            return `<div class="bg-slate-100 dark:bg-slate-700/50 rounded-xl p-4 text-center">
                                <i class="fa-solid fa-info-circle text-slate-400 text-lg mb-2"></i>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Solo puedes ocupar mesas para hoy en el turno actual (${turnoNombre}).</p>
                                <button onclick="ShiftController.goToCurrent(); Modal.close();" class="mt-2 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
                                    <i class="fa-solid fa-arrow-right mr-1"></i>Ir a hoy ${turnoNombre}
                                </button>
                            </div>`;
                        }
                    })()}
                    
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200 dark:border-slate-700"></div></div>
                        <div class="relative flex justify-center text-sm"><span class="px-3 bg-white dark:bg-slate-800 text-slate-500">o crear reserva</span></div>
                    </div>
                    
                    <!-- Reservation Form -->
                    <form id="reserve-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Nombre del cliente</label>
                            <input type="text" name="customer_name" required placeholder="Nombre completo" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Tel√©fono</label>
                            <input type="tel" name="telefono" placeholder="Opcional" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    <i class="fa-regular fa-calendar mr-1"></i>Fecha
                                </label>
                                <input type="date" name="fecha" required value="${State.selectedDate}" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    <i class="fa-regular fa-clock mr-1"></i>Hora
                                </label>
                                <select name="time" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500">
                                    <optgroup label="Mediod√≠a">
                                        <option value="12:00">12:00</option>
                                        <option value="12:15">12:15</option>
                                        <option value="12:30">12:30</option>
                                        <option value="12:45">12:45</option>
                                        <option value="13:00">13:00</option>
                                        <option value="13:15">13:15</option>
                                        <option value="13:30">13:30</option>
                                        <option value="13:45">13:45</option>
                                        <option value="14:00">14:00</option>
                                        <option value="14:15">14:15</option>
                                        <option value="14:30">14:30</option>
                                        <option value="14:45">14:45</option>
                                        <option value="15:00">15:00</option>
                                        <option value="15:15">15:15</option>
                                        <option value="15:30">15:30</option>
                                        <option value="15:45">15:45</option>
                                        <option value="16:00">16:00</option>
                                        <option value="16:30">16:30</option>
                                    </optgroup>
                                    <optgroup label="Noche">
                                        <option value="20:00" selected>20:00</option>
                                        <option value="20:15">20:15</option>
                                        <option value="20:30">20:30</option>
                                        <option value="20:45">20:45</option>
                                        <option value="21:00">21:00</option>
                                        <option value="21:15">21:15</option>
                                        <option value="21:30">21:30</option>
                                        <option value="21:45">21:45</option>
                                        <option value="22:00">22:00</option>
                                        <option value="22:15">22:15</option>
                                        <option value="22:30">22:30</option>
                                        <option value="22:45">22:45</option>
                                        <option value="23:00">23:00</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                <i class="fa-solid fa-users mr-1"></i>Personas (m√°x ${table.capacity})
                            </label>
                            <div class="flex gap-2">
                                ${[1, 2, 3, 4, 5, 6].filter(n => n <= table.capacity).map(n => `
                                    <button type="button" class="people-btn flex-1 py-2.5 rounded-xl border-2 ${n === 2 ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' : 'border-slate-200 dark:border-slate-600 hover:border-indigo-300'} font-semibold transition-all" data-count="${n}">${n}</button>
                                `).join('')}
                            </div>
                            <input type="hidden" name="people" value="2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                <i class="fa-regular fa-note-sticky mr-1"></i>Notas (opcional)
                            </label>
                            <textarea name="notas" rows="2" placeholder="Alergias, preferencias, celebraciones..." class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
                        </div>
                        <button type="submit" id="submit-reservation" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
                            <i class="fa-solid fa-calendar-plus"></i>
                            Confirmar Reserva
                        </button>
                    </form>
                    
                    ${canEdit ? `
                    <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                        <p class="text-xs text-slate-500 mb-3">Opciones de administrador</p>
                        <div class="flex gap-2">
                            <button onclick="Modal.editTable('${table.id}')" class="flex-1 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-sm rounded-lg transition-colors flex items-center justify-center gap-1">
                                <i class="fa-solid fa-pen"></i> Editar
                            </button>
                            <button onclick="Modal.deleteTable('${table.id}')" class="py-2 px-3 bg-rose-100 dark:bg-rose-900/30 hover:bg-rose-200 dark:hover:bg-rose-900/50 text-rose-600 dark:text-rose-400 text-sm rounded-lg transition-colors">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

                // People selector buttons
                document.querySelectorAll('.people-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.people-btn').forEach(b => {
                            b.className = 'people-btn flex-1 py-2.5 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-indigo-300 font-semibold transition-all';
                        });
                        btn.className = 'people-btn flex-1 py-2.5 rounded-xl border-2 border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-semibold transition-all';
                        document.querySelector('input[name="people"]').value = btn.dataset.count;
                    });
                });

                document.getElementById('reserve-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('submit-reservation');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creando...';
                    btn.disabled = true;

                    const formData = new FormData(e.target);
                    await this.createReservation(table.id, {
                        customer_name: formData.get('customer_name'),
                        telefono: formData.get('telefono') || '',
                        fecha: formData.get('fecha'),
                        time: formData.get('time'),
                        people: parseInt(formData.get('people')),
                        notas: formData.get('notas') || ''
                    });

                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            },

            renderOccupiedDetails(table) {
                const info = table.reservation_info || {};
                const isOccupied = table.status === 'occupied';
                const canEdit = Utils.canEdit();

                this.content.innerHTML = `
                <div class="space-y-4">
                    <div class="${isOccupied ? 'bg-amber-50 dark:bg-amber-900/20' : 'bg-rose-50 dark:bg-rose-900/20'} rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 ${isOccupied ? 'bg-amber-100 dark:bg-amber-800' : 'bg-rose-100 dark:bg-rose-800'} rounded-xl flex items-center justify-center">
                                <i class="fa-solid ${isOccupied ? 'fa-utensils' : 'fa-calendar-check'} ${isOccupied ? 'text-amber-600 dark:text-amber-300' : 'text-rose-600 dark:text-rose-300'}"></i>
                            </div>
                            <div>
                                <div class="font-semibold ${isOccupied ? 'text-amber-900 dark:text-amber-100' : 'text-rose-900 dark:text-rose-100'}">${table.name}</div>
                                <div class="text-sm ${isOccupied ? 'text-amber-600 dark:text-amber-300' : 'text-rose-600 dark:text-rose-300'}">${isOccupied ? 'Mesa ocupada' : 'Mesa reservada'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 space-y-2">
                        <div class="flex items-center gap-3 text-sm">
                            <i class="fa-solid fa-user text-slate-400 w-4"></i>
                            <span class="text-slate-700 dark:text-slate-200">${info.customer_name || 'Sin datos'}</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm">
                            <i class="fa-solid fa-clock text-slate-400 w-4"></i>
                            <span class="text-slate-700 dark:text-slate-200">${info.time || 'N/A'}</span>
                        </div>
                        ${info.people ? `
                        <div class="flex items-center gap-3 text-sm">
                            <i class="fa-solid fa-users text-slate-400 w-4"></i>
                            <span class="text-slate-700 dark:text-slate-200">${info.people} personas</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        ${table.status === 'reserved' ? `
                        <button onclick="Modal.markAsOccupied('${table.id}')" class="py-3 bg-amber-500 hover:bg-amber-600 text-white font-medium rounded-xl transition-colors flex items-center justify-center gap-2">
                            <i class="fa-solid fa-utensils"></i> Cliente lleg√≥
                        </button>
                        ` : `
                        <button onclick="Modal.freeTable('${table.id}')" class="py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-xl transition-colors flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check"></i> Liberar
                        </button>
                        `}
                        <button onclick="Modal.freeTable('${table.id}')" class="py-3 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-200 font-medium rounded-xl transition-colors flex items-center justify-center gap-2">
                            <i class="fa-solid fa-times"></i> Cancelar
                        </button>
                    </div>
                    
                    ${canEdit ? `
                    <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                        <button onclick="Modal.deleteTable('${table.id}')" class="w-full py-2 bg-rose-100 dark:bg-rose-900/30 hover:bg-rose-200 dark:hover:bg-rose-900/50 text-rose-600 dark:text-rose-400 text-sm rounded-lg transition-colors flex items-center justify-center gap-1">
                            <i class="fa-solid fa-trash"></i> Eliminar mesa
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            },

            async occupyWalkIn(tableId) {
                try {
                    // Determinar turno actual basado en la hora
                    const ahora = new Date();
                    const hora = ahora.getHours();
                    const turnoActual = hora < 17 ? 'mediodia' : 'noche';
                    const fechaHoy = ahora.toISOString().split('T')[0];

                    // Ocupar la mesa para hoy y turno actual
                    const result = await API.request('POST', `/api/tables/${tableId}/occupy`, {
                        fecha: fechaHoy,
                        turno: turnoActual
                    });

                    if (result.success) {
                        Utils.showToast('Mesa ocupada', 'success');
                        this.close();

                        // Navegar a la fecha y turno actuales para ver la mesa ocupada
                        State.selectedDate = fechaHoy;
                        State.currentShift = turnoActual;

                        // Actualizar UI
                        document.getElementById('date-picker').value = fechaHoy;

                        // Actualizar botones de turno
                        document.querySelectorAll('.shift-btn').forEach(btn => {
                            if (btn.dataset.shift === turnoActual) {
                                btn.className = turnoActual === 'mediodia'
                                    ? 'shift-btn px-3 py-2 text-sm font-medium bg-orange-500 text-white'
                                    : 'shift-btn px-3 py-2 text-sm font-medium bg-amber-500 text-white';
                            } else {
                                btn.className = 'shift-btn px-3 py-2 text-sm font-medium bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600';
                            }
                        });

                        await TableRenderer.loadAndRender();
                        Utils.showToast(`Vista actualizada: ${turnoActual === 'mediodia' ? 'Mediod√≠a' : 'Noche'}`, 'info');
                    } else {
                        Utils.showToast(result.message, 'error');
                    }
                } catch (e) {
                    Utils.showToast('Error de conexi√≥n', 'error');
                }
            },

            async createReservation(tableId, data) {
                try {
                    const result = await API.reserveTable(tableId, data);
                    if (result.success) {
                        Utils.showToast('Reserva creada', 'success');
                        this.close();
                        await TableRenderer.loadAndRender();
                    } else {
                        Utils.showToast(result.message, 'error');
                    }
                } catch (e) {
                    Utils.showToast('Error de conexi√≥n', 'error');
                }
            },

            async markAsOccupied(tableId) {
                try {
                    const table = State.tables.find(t => t.id === tableId);
                    if (table) {
                        table.status = 'occupied';
                        await API.request('POST', '/api/update_booking', { table_id: tableId, action: 'occupy' });
                        Utils.showToast('Cliente lleg√≥', 'success');
                        this.close();
                        await TableRenderer.loadAndRender();
                    }
                } catch (e) {
                    Utils.showToast('Error', 'error');
                }
            },

            async freeTable(tableId) {
                try {
                    const result = await API.freeTable(tableId);
                    if (result.success) {
                        Utils.showToast('Mesa liberada', 'success');
                        this.close();
                        await TableRenderer.loadAndRender();
                    } else {
                        Utils.showToast(result.message, 'error');
                    }
                } catch (e) {
                    Utils.showToast('Error de conexi√≥n', 'error');
                }
            },

            async deleteTable(tableId) {
                if (!confirm('¬øEliminar esta mesa permanentemente?')) return;

                try {
                    const result = await API.deleteTable(tableId);
                    if (result.success) {
                        Utils.showToast('Mesa eliminada', 'success');
                        this.close();
                        await TableRenderer.loadAndRender();
                    } else {
                        Utils.showToast(result.message, 'error');
                    }
                } catch (e) {
                    Utils.showToast('Error de conexi√≥n', 'error');
                }
            },

            editTable(tableId) {
                const table = State.tables.find(t => t.id === tableId);
                if (!table) return;

                this.title.innerHTML = '<i class="fa-solid fa-pen text-indigo-500"></i> Editar Mesa';

                this.content.innerHTML = `
                <form id="edit-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Nombre</label>
                        <input type="text" name="name" value="${table.name}" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Capacidad</label>
                        <input type="number" name="capacity" value="${table.capacity}" min="1" max="20" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Zona</label>
                        <select name="zone" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500">
                            <option value="interior" ${table.zone === 'interior' ? 'selected' : ''}>Interior</option>
                            <option value="terraza" ${table.zone === 'terraza' ? 'selected' : ''}>Terraza</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl transition-colors">
                        Guardar Cambios
                    </button>
                </form>
            `;

                document.getElementById('edit-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    try {
                        const result = await API.updateTable(tableId, {
                            name: formData.get('name'),
                            capacity: parseInt(formData.get('capacity')),
                            zone: formData.get('zone')
                        });
                        if (result.success) {
                            Utils.showToast('Mesa actualizada', 'success');
                            this.close();
                            await TableRenderer.loadAndRender();
                        } else {
                            Utils.showToast(result.message, 'error');
                        }
                    } catch (e) {
                        Utils.showToast('Error de conexi√≥n', 'error');
                    }
                });
            },

            openCreateTable() {
                this.open('Nueva Mesa', 'fa-plus');

                this.content.innerHTML = `
                <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl text-sm text-blue-700 dark:text-blue-300">
                    <i class="fa-solid fa-info-circle mr-1"></i>
                    El nombre de la mesa se asigna autom√°ticamente (Mesa 11, Mesa 12, etc.)
                </div>
                <form id="create-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Capacidad (personas)</label>
                        <select name="capacity" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500">
                            <option value="2">2 personas</option>
                            <option value="4" selected>4 personas</option>
                            <option value="6">6 personas</option>
                            <option value="8">8 personas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Zona</label>
                        <select name="zone" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500">
                            <option value="interior" ${State.currentZone === 'interior' ? 'selected' : ''}>Interior</option>
                            <option value="terraza" ${State.currentZone === 'terraza' ? 'selected' : ''}>Terraza</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i>
                        Crear Mesa
                    </button>
                </form>
            `;

                document.getElementById('create-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    try {
                        const result = await API.createTable({
                            capacity: parseInt(formData.get('capacity')),
                            zone: formData.get('zone')
                        });
                        if (result.success) {
                            Utils.showToast('Mesa creada', 'success');
                            this.close();
                            await TableRenderer.loadAndRender();
                        } else {
                            Utils.showToast(result.message, 'error');
                        }
                    } catch (e) {
                        Utils.showToast('Error de conexi√≥n', 'error');
                    }
                });
            }
        };

        // =============================================
        // ZONE CONTROLLER
        // =============================================
        const ZoneController = {
            init() {
                document.querySelectorAll('.zone-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switch(btn.dataset.zone));
                });
            },

            switch(zone) {
                State.currentZone = zone;

                document.querySelectorAll('.zone-btn').forEach(btn => {
                    if (btn.dataset.zone === zone) {
                        btn.className = 'zone-btn px-3 py-2 text-sm font-medium bg-indigo-600 text-white';
                    } else {
                        btn.className = 'zone-btn px-3 py-2 text-sm font-medium bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600';
                    }
                });

                TableRenderer.render();
            }
        };

        // =============================================
        // SHIFT CONTROLLER
        // =============================================
        const ShiftController = {
            init() {
                document.querySelectorAll('.shift-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switch(btn.dataset.shift));

                    // Apply correct initial styling
                    if (btn.dataset.shift === State.currentShift) {
                        btn.className = State.currentShift === 'mediodia'
                            ? 'shift-btn px-3 py-2 text-sm font-medium bg-orange-500 text-white'
                            : 'shift-btn px-3 py-2 text-sm font-medium bg-amber-500 text-white';
                    } else {
                        btn.className = 'shift-btn px-3 py-2 text-sm font-medium bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600';
                    }
                });
            },

            async switch(shift) {
                State.currentShift = shift;

                document.querySelectorAll('.shift-btn').forEach(btn => {
                    if (btn.dataset.shift === shift) {
                        if (shift === 'mediodia') {
                            btn.className = 'shift-btn px-3 py-2 text-sm font-medium bg-orange-500 text-white';
                        } else {
                            btn.className = 'shift-btn px-3 py-2 text-sm font-medium bg-amber-500 text-white';
                        }
                    } else {
                        btn.className = 'shift-btn px-3 py-2 text-sm font-medium bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600';
                    }
                });

                // Reload tables for selected shift
                Utils.showToast(`Turno: ${shift === 'mediodia' ? 'Mediod√≠a' : 'Noche'}`, 'info');
                await TableRenderer.loadAndRender();
            },

            async goToCurrent() {
                // Ir al d√≠a de hoy y al turno actual
                const hoy = new Date().toISOString().split('T')[0];
                const turnoActual = new Date().getHours() < 17 ? 'mediodia' : 'noche';

                State.selectedDate = hoy;
                document.getElementById('date-picker').value = hoy;
                DateController.updateDisplay();

                await this.switch(turnoActual);
            }
        };

        // =============================================
        // DATE CONTROLLER
        // =============================================
        const DateController = {
            picker: null,
            display: null,

            init() {
                this.picker = document.getElementById('date-picker');
                this.display = document.getElementById('date-display');
                this.picker.value = State.selectedDate;
                this.updateDisplay();

                // Date change handler
                this.picker.addEventListener('change', async (e) => {
                    State.selectedDate = e.target.value;
                    this.updateDisplay();
                    await TableRenderer.loadAndRender();
                });

                // Navigation buttons
                document.getElementById('date-prev').addEventListener('click', () => this.navigate(-1));
                document.getElementById('date-next').addEventListener('click', () => this.navigate(1));
                document.getElementById('date-today').addEventListener('click', () => this.goToToday());
            },

            updateDisplay() {
                const date = new Date(State.selectedDate + 'T12:00:00');
                const options = { weekday: 'short', day: 'numeric', month: 'short' };
                this.display.textContent = date.toLocaleDateString('es-ES', options);
            },

            async navigate(days) {
                const current = new Date(State.selectedDate);
                current.setDate(current.getDate() + days);
                State.selectedDate = current.toISOString().split('T')[0];
                this.picker.value = State.selectedDate;
                this.updateDisplay();
                await TableRenderer.loadAndRender();
            },

            async goToToday() {
                State.selectedDate = new Date().toISOString().split('T')[0];
                this.picker.value = State.selectedDate;
                this.updateDisplay();
                await TableRenderer.loadAndRender();
                Utils.showToast('Fecha: Hoy', 'info');
            }
        };

        // =============================================
        // THEME
        // =============================================
        const Theme = {
            init() {
                if (localStorage.getItem('darkMode') === 'true' ||
                    (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }

                document.getElementById('dark-toggle').addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
                });
            }
        };

        // =============================================
        // SYNC CONTROLLER - Auto-refresh every 4s
        // =============================================
        const SyncController = {
            pollInterval: null,
            POLL_DELAY: 4000,  // 4 seconds
            lastDataHash: null,
            localPositions: {},  // Cache local positions during drag
            isDragging: false,   // Flag to skip sync during drag

            init() {
                this.startPolling();
                console.log('[SYNC] Auto-refresh iniciado (4s)');
            },

            startPolling() {
                if (this.pollInterval) clearInterval(this.pollInterval);
                this.pollInterval = setInterval(async () => {
                    await this.syncTables();
                }, this.POLL_DELAY);
            },

            stopPolling() {
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                }
            },

            // Llamar cuando empieza el drag
            setDragging(tableId, x, y) {
                this.isDragging = true;
                this.localPositions[tableId] = { x, y };
            },

            // Llamar cuando termina el drag
            clearDragging(tableId) {
                this.isDragging = false;
                // Mantener la posici√≥n local por un momento para evitar race condition
                setTimeout(() => {
                    delete this.localPositions[tableId];
                }, this.POLL_DELAY + 1000);
            },

            async syncTables() {
                // No sincronizar mientras se arrastra
                if (this.isDragging) {
                    console.log('[SYNC] Skipping - drag in progress');
                    return;
                }

                try {
                    const tables = await API.getTables(State.selectedDate, State.currentShift);

                    // Aplicar posiciones locales sobre las de la DB
                    tables.forEach(t => {
                        if (this.localPositions[t.id]) {
                            t.x = this.localPositions[t.id].x;
                            t.y = this.localPositions[t.id].y;
                        }
                    });

                    const newHash = JSON.stringify(tables);

                    // Solo actualizar si hay cambios
                    if (newHash !== this.lastDataHash) {
                        this.lastDataHash = newHash;
                        State.tables = tables;
                        TableRenderer.render();
                        console.log('[SYNC] Datos actualizados');
                    }
                } catch (e) {
                    console.error('[SYNC] Error:', e);
                }
            }
        };

        // =============================================
        // INIT
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            Theme.init();

            // Check auth
            const isLoggedIn = await Auth.init();
            if (!isLoggedIn) return;

            // Hide loading, show app
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');

            // Initialize modules
            Auth.updateUI();
            TableRenderer.init();
            Modal.init();
            ZoneController.init();
            ShiftController.init();
            DateController.init();
            SyncController.init();  // Start auto-refresh

            // Load tables
            await TableRenderer.loadAndRender();

            // Event listeners
            document.getElementById('logout-btn').addEventListener('click', () => Auth.logout());
            document.getElementById('btn-add-table').addEventListener('click', () => Modal.openCreateTable());
        });
    </script>
</body>

</html>